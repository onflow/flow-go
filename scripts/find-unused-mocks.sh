#!/usr/bin/env bash
set -euo pipefail

# Parse flags
VERBOSE=false
while getopts "v" opt; do
  case $opt in
    v) VERBOSE=true ;;
    *) echo "Usage: $0 [-v] [root_dir]" >&2; exit 1 ;;
  esac
done
shift $((OPTIND - 1))

# Root of the repo to search
ROOT="${1:-.}"

# Go module import prefix
MODULE_PREFIX="github.com/onflow/flow-go"

# Mockery header we are looking for
MOCKERY_HEADER='^// Code generated by mockery; DO NOT EDIT\.'

# Temporary storage for package paths
packages=()

# Step 1: Find all mockery-generated files
while IFS= read -r -d '' file; do
  # Remove leading ./ if present
  relative_path="${file#./}"

  # Get directory containing the file
  package_dir="${relative_path%/*}"

  # Build full Go import path
  package_path="${MODULE_PREFIX}/${package_dir}"

  packages+=("$package_path")
done < <(
  grep -rlZ "$MOCKERY_HEADER" "$ROOT"
)

# Step 2: Deduplicate packages
IFS=$'\n' read -r -d '' -a unique_packages < <(printf '%s\n' "${packages[@]}" | sort -u && printf '\0') || true

# 3) Find unused (not referenced in *.go files)
unused_packages=()
used_packages=()
for pkg in "${unique_packages[@]}"; do
  if ! grep -R --include="*.go" -Fq -- "$pkg" "$ROOT"; then
    unused_packages+=("$pkg")
  else
    used_packages+=("$pkg")
  fi
done

# 4) Output used packages if verbose
if $VERBOSE && ((${#used_packages[@]} > 0)); then
  printf 'Used mock packages:\n'
  printf '  %s\n' "${used_packages[@]}"
fi

# 5) Output unused packages, then fail if any exist
if ((${#unused_packages[@]} > 0)); then
  printf 'Generated mock packages are unused. Please exclude them from `.mockery.yaml` and remove them: %s\n' "${unused_packages[@]}"
  exit 1
fi

exit 0
