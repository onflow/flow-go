#!/usr/bin/env bash
set -euo pipefail

# Root of the repo to search
ROOT="${1:-.}"

# Go module import prefix
MODULE_PREFIX="github.com/onflow/flow-go"

# Mockery header we are looking for
MOCKERY_HEADER='^// Code generated by mockery; DO NOT EDIT\.'

# Temporary storage for package paths
packages=()

# Step 1: Find all mockery-generated files
while IFS= read -r -d '' file; do
  # Remove leading ./ if present
  relative_path="${file#./}"

  # Get directory containing the file
  package_dir="${relative_path%/*}"

  # Build full Go import path
  package_path="${MODULE_PREFIX}/${package_dir}"

  packages+=("$package_path")
done < <(
  grep -rlZ "$MOCKERY_HEADER" "$ROOT"
)

# 3) Find unused (not referenced in *_test.go)
unused_packages=()
for pkg in "${unique_packages[@]}"; do
  if ! grep -R --include="*.go" -Fq -- "$pkg" "$ROOT"; then
    unused_packages+=("$pkg")
  fi
done

# 4) Output unused packages, then fail if any exist
if ((${#unused_packages[@]} > 0)); then
  printf 'Generated mock packages are unused. Please exclude them from `.mockery.yaml` and remove them: %s\n' "${unused_packages[@]}"
  exit 1
fi

exit 0
